/*
 * UART.c
 *
 *  Created on: Feb 5, 2025
 *      Author: NCPC
 */

#include "UART.h"

extern UART_HandleTypeDef huart2;

void HAL_UART_RxCpltCallback(UART_HandleTypeDef *huart) {
    if (huart->Instance == USART2) {
    	if(OTA_mode == OTA_INIT){
    		if(rx_data == '\r' || rx_data == '\n'){
    			uart_rx[uart_count] = '\0';
    			if(strcmp((char* )uart_rx, "OTA_START") == 0){
    				OTA_Start();
    				OTA_mode = OTA_START;
    			}
    			else{
    				OTA_mode = OTA_INIT;
    			}
				uart_count = 0;
				memset(uart_rx, 0 ,sizeof(uart_rx));
    		}else{
        		uart_rx[uart_count]= rx_data;
        		uart_count++;
    		}
    	}
    	else if (OTA_mode == OTA_START) {
    		Firmware_rx[cur_line][cur_index++] = rx_data;
    	    if (cur_index == 4 &&
    	        Firmware_rx[cur_line][0] == '#' &&
    	        Firmware_rx[cur_line][1] == '#' &&
    	        Firmware_rx[cur_line][2] == '#' &&
    	        Firmware_rx[cur_line][3] == '#') {

    	        OTA_End();
    	        OTA_mode = OTA_END;
    	    	Process_Bin_File();
    	    }
    		if (cur_index >= 4) {
    			cur_index = 0;
    			cur_line++;
    		}
    	}
	    HAL_UART_Receive_IT(&huart2, &rx_data, 1);
    }
}
